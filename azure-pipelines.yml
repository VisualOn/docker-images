trigger:
  batch: true
  branches:
    include:
      - "master"
      - "staging"
      - "trying"
pr:
  autoCancel: true
  branches:
    include:
      - "*"

variables:
  DOCKER_BUILDKIT: 1
  CI: true

jobs:
  - job: build_dotnet
    displayName: Build dotnet
    timeoutInMinutes: 10
    pool:
      vmImage: "ubuntu-16.04"
    strategy:
      matrix:
        aspnet:
          imageName: "dotnet-aspnet"
          testCommand: "dotnet --info"
        sdk:
          imageName: "dotnet-sdk"
          testCommand: "dotnet --info"
        renovate:
          imageName: "renovate"
          testCommand: "renovate --version"
    steps:
      - template: .azure/build.yml
      - template: .azure/test.yml

  - job: publish_dotnet
    displayName: Publish dotnet
    timeoutInMinutes: 10
    dependsOn: build_dotnet
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    pool:
      vmImage: "ubuntu-16.04"
    strategy:
      matrix:
        aspnet:
          imageName: "dotnet-aspnet"
        sdk:
          imageName: "dotnet-sdk"
        renovate:
          imageName: "renovate"
    steps:
      - template: .azure/build.yml
        parameters:
          command: buildAndPush
